{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.5.6.12127",
      "templateHash": "3916115484081319486"
    }
  },
  "parameters": {
    "appName": {
      "type": "string"
    },
    "environment": {
      "type": "string"
    },
    "region": {
      "type": "string"
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "theKingOfAustriaSecretValue": {
      "type": "secureString",
      "defaultValue": "asdf"
    },
    "theKingOfPrussiaSecretValue": {
      "type": "secureString",
      "defaultValue": "asdf"
    },
    "theKingOfEnglandSecretValue": {
      "type": "secureString",
      "defaultValue": "asdf"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "resource-names",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appName": {
            "value": "[parameters('appName')]"
          },
          "region": {
            "value": "[parameters('region')]"
          },
          "env": {
            "value": "[parameters('environment')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "3990323016488998520"
            }
          },
          "parameters": {
            "appName": {
              "type": "string"
            },
            "region": {
              "type": "string"
            },
            "env": {
              "type": "string"
            }
          },
          "resources": [],
          "outputs": {
            "appInsightsName": {
              "type": "string",
              "value": "[format('ai-{0}-{1}-{2}', parameters('appName'), parameters('region'), parameters('env'))]"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "value": "[format('la-{0}-{1}-{2}', parameters('appName'), parameters('region'), parameters('env'))]"
            },
            "appServicePlanName": {
              "type": "string",
              "value": "[format('asp-{0}-{1}-{2}', parameters('appName'), parameters('region'), parameters('env'))]"
            },
            "appServiceNetCoreName": {
              "type": "string",
              "value": "[format('wa-net-core-{0}-{1}-{2}', parameters('appName'), parameters('region'), parameters('env'))]"
            },
            "appServiceNetFrameworkName": {
              "type": "string",
              "value": "[format('wa-net-framework-{0}-{1}-{2}', parameters('appName'), parameters('region'), parameters('env'))]"
            },
            "keyVaultName": {
              "type": "string",
              "value": "[format('kv-{0}-{1}-{2}', parameters('appName'), parameters('region'), parameters('env'))]"
            },
            "managedIdentityName": {
              "type": "string",
              "value": "[format('mi-{0}-{1}-{2}', parameters('appName'), parameters('region'), parameters('env'))]"
            },
            "theKingOfAustriaSecretName": {
              "type": "string",
              "value": "the-king-of-austria"
            },
            "theKingOfPrussiaSecretName": {
              "type": "string",
              "value": "the-king-of-prussia"
            },
            "theKingOfEnglandSecretName": {
              "type": "string",
              "value": "the-king-of-england"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "managed-identity-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "managedIdentityName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'resource-names')).outputs.managedIdentityName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "12111838882217808816"
            }
          },
          "parameters": {
            "managedIdentityName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2018-11-30",
              "name": "[parameters('managedIdentityName')]",
              "location": "[parameters('location')]"
            }
          ],
          "outputs": {
            "managedIdentityName": {
              "type": "string",
              "value": "[parameters('managedIdentityName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'resource-names')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "logging-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "logAnalyticsWorkspaceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'resource-names')).outputs.logAnalyticsWorkspaceName.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "appInsightsName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'resource-names')).outputs.appInsightsName.value]"
          },
          "appServiceNetCoreName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'resource-names')).outputs.appServiceNetCoreName.value]"
          },
          "appServiceNetFrameworkName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'resource-names')).outputs.appServiceNetFrameworkName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "18157334792194158903"
            }
          },
          "parameters": {
            "logAnalyticsWorkspaceName": {
              "type": "string"
            },
            "appInsightsName": {
              "type": "string"
            },
            "appServiceNetCoreName": {
              "type": "string"
            },
            "appServiceNetFrameworkName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2021-06-01",
              "name": "[parameters('logAnalyticsWorkspaceName')]",
              "location": "[parameters('location')]"
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('appInsightsName')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "Flow_Type": "Bluefield",
                "Request_Source": "rest",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
              },
              "tags": {
                "[format('hidden-link:{0}/providers/Microsoft.Web/sites/{1}', resourceGroup().id, parameters('appServiceNetCoreName'))]": "Resource",
                "[format('hidden-link:{0}/providers/Microsoft.Web/sites/{1}', resourceGroup().id, parameters('appServiceNetFrameworkName'))]": "Resource"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
              ]
            }
          ],
          "outputs": {
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "value": "[parameters('logAnalyticsWorkspaceName')]"
            },
            "appInsightsName": {
              "type": "string",
              "value": "[parameters('appInsightsName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'resource-names')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "key-vault-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'resource-names')).outputs.keyVaultName.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logging-deployment')).outputs.logAnalyticsWorkspaceName.value]"
          },
          "managedIdentityName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')).outputs.managedIdentityName.value]"
          },
          "theKingOfAustriaSecretName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'resource-names')).outputs.theKingOfAustriaSecretName.value]"
          },
          "theKingOfAustriaSecretValue": {
            "value": "[parameters('theKingOfAustriaSecretValue')]"
          },
          "theKingOfPrussiaSecretName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'resource-names')).outputs.theKingOfPrussiaSecretName.value]"
          },
          "theKingOfPrussiaSecretValue": {
            "value": "[parameters('theKingOfPrussiaSecretValue')]"
          },
          "theKingOfEnglandSecretName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'resource-names')).outputs.theKingOfEnglandSecretName.value]"
          },
          "theKingOfEnglandSecretValue": {
            "value": "[parameters('theKingOfEnglandSecretValue')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "12773717666626680770"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "managedIdentityName": {
              "type": "string"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string"
            },
            "theKingOfAustriaSecretName": {
              "type": "string"
            },
            "theKingOfAustriaSecretValue": {
              "type": "secureString"
            },
            "theKingOfPrussiaSecretName": {
              "type": "string"
            },
            "theKingOfPrussiaSecretValue": {
              "type": "secureString"
            },
            "theKingOfEnglandSecretName": {
              "type": "string"
            },
            "theKingOfEnglandSecretValue": {
              "type": "secureString"
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-10-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('theKingOfAustriaSecretName'))]",
              "properties": {
                "value": "[parameters('theKingOfAustriaSecretValue')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-10-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('theKingOfPrussiaSecretName'))]",
              "properties": {
                "value": "[parameters('theKingOfPrussiaSecretValue')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-10-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('theKingOfEnglandSecretName'))]",
              "properties": {
                "value": "[parameters('theKingOfEnglandSecretValue')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2021-10-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[subscription().tenantId]",
                "enableRbacAuthorization": false,
                "accessPolicies": [
                  {
                    "permissions": {
                      "secrets": [
                        "get",
                        "list"
                      ]
                    },
                    "objectId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2018-11-30').principalId]",
                    "tenantId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2018-11-30').tenantId]"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2017-05-01-preview",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "Logging",
              "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]",
                "logs": [
                  {
                    "category": "AuditEvent",
                    "enabled": true
                  },
                  {
                    "category": "AzurePolicyEvaluationDetails",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultName": {
              "type": "string",
              "value": "[parameters('keyVaultName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'logging-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'resource-names')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "app-service-plan-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appServicePlanName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'resource-names')).outputs.appServicePlanName.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "4935628598921498728"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appServicePlanName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2021-03-01",
              "name": "[parameters('appServicePlanName')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "sku": {
                "name": "S1",
                "tier": "Standard",
                "size": "S1",
                "family": "S",
                "capacity": 1
              }
            }
          ],
          "outputs": {
            "appServicePlanName": {
              "type": "string",
              "value": "[parameters('appServicePlanName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'resource-names')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "app-service-net-core-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appInsightsName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logging-deployment')).outputs.appInsightsName.value]"
          },
          "appServiceNetCoreName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'resource-names')).outputs.appServiceNetCoreName.value]"
          },
          "appServicePlanName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-service-plan-deployment')).outputs.appServicePlanName.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logging-deployment')).outputs.logAnalyticsWorkspaceName.value]"
          },
          "managedIdentityName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')).outputs.managedIdentityName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "10256484872002266645"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appServicePlanName": {
              "type": "string"
            },
            "appServiceNetCoreName": {
              "type": "string"
            },
            "managedIdentityName": {
              "type": "string"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string"
            },
            "appInsightsName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2021-03-01",
              "name": "[parameters('appServiceNetCoreName')]",
              "location": "[parameters('location')]",
              "kind": "app,windows",
              "identity": {
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')))]": {}
                }
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
                "keyVaultReferenceIdentity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]",
                "siteConfig": {
                  "netFrameworkVersion": "v6.0",
                  "appSettings": [
                    {
                      "name": "Authentication__ManagedIdentityClientId",
                      "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2021-09-30-preview').clientId]"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').InstrumentationKey]"
                    },
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').ConnectionString]"
                    },
                    {
                      "name": "ApplicationInsightsAgent_EXTENSION_VERSION",
                      "value": "~3"
                    },
                    {
                      "name": "IsHostedOnPrem",
                      "value": "false"
                    },
                    {
                      "name": "XDT_MicrosoftApplicationInsights_Mode",
                      "value": "Recommended"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2017-05-01-preview",
              "scope": "[format('Microsoft.Web/sites/{0}', parameters('appServiceNetCoreName'))]",
              "name": "Logging",
              "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]",
                "logs": [
                  {
                    "category": "AppServiceHTTPLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceConsoleLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceAppLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceAuditLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceIPSecAuditLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServicePlatformLogs",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('appServiceNetCoreName'))]"
              ]
            }
          ],
          "outputs": {
            "appServicePlanName": {
              "type": "string",
              "value": "[parameters('appServicePlanName')]"
            },
            "appServiceNetCoreName": {
              "type": "string",
              "value": "[parameters('appServiceNetCoreName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-service-plan-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'logging-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'resource-names')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "app-service-net-framework-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appInsightsName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logging-deployment')).outputs.appInsightsName.value]"
          },
          "appServiceNetFrameworkName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'resource-names')).outputs.appServiceNetFrameworkName.value]"
          },
          "appServicePlanName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-service-plan-deployment')).outputs.appServicePlanName.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logging-deployment')).outputs.logAnalyticsWorkspaceName.value]"
          },
          "managedIdentityName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')).outputs.managedIdentityName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.5.6.12127",
              "templateHash": "1696515630527041058"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appServicePlanName": {
              "type": "string"
            },
            "appServiceNetFrameworkName": {
              "type": "string"
            },
            "managedIdentityName": {
              "type": "string"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string"
            },
            "appInsightsName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2021-03-01",
              "name": "[parameters('appServiceNetFrameworkName')]",
              "location": "[parameters('location')]",
              "kind": "app,windows",
              "identity": {
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')))]": {}
                }
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
                "keyVaultReferenceIdentity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]",
                "siteConfig": {
                  "netFrameworkVersion": "v4.8",
                  "appSettings": [
                    {
                      "name": "Authentication:ManagedIdentityClientId",
                      "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2021-09-30-preview').clientId]"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').InstrumentationKey]"
                    },
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').ConnectionString]"
                    },
                    {
                      "name": "ApplicationInsightsAgent_EXTENSION_VERSION",
                      "value": "~3"
                    },
                    {
                      "name": "IsHostedOnPrem",
                      "value": "false"
                    },
                    {
                      "name": "XDT_MicrosoftApplicationInsights_Mode",
                      "value": "Recommended"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2017-05-01-preview",
              "scope": "[format('Microsoft.Web/sites/{0}', parameters('appServiceNetFrameworkName'))]",
              "name": "Logging",
              "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]",
                "logs": [
                  {
                    "category": "AppServiceHTTPLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceConsoleLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceAppLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceAuditLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceIPSecAuditLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServicePlatformLogs",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('appServiceNetFrameworkName'))]"
              ]
            }
          ],
          "outputs": {
            "appServicePlanName": {
              "type": "string",
              "value": "[parameters('appServicePlanName')]"
            },
            "appServiceNetFrameworkName": {
              "type": "string",
              "value": "[parameters('appServiceNetFrameworkName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-service-plan-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'logging-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'resource-names')]"
      ]
    }
  ]
}